<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Debugger - Live Feed</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
    />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link href="/assets/style.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="header">
      <h1>Live Debug Feed</h1>
      <div id="status">
        <span class="status-dot"></span> Auto-syncing:
        <span id="last-update">--</span>
      </div>
    </div>
    <div class="container">
      <div id="logs"></div>
    </div>

    <script>
      const logsContainer = document.getElementById("logs");
      const lastUpdateSpan = document.getElementById("last-update");
      let lastJsonString = "";

      marked.setOptions({
        highlight: function (code, lang) {
          const language = hljs.getLanguage(lang) ? lang : "plaintext";
          return hljs.highlight(code, { language }).value;
        },
        breaks: true,
      });

      async function fetchLogs() {
        try {
          const response = await fetch("debug.json?t=" + new Date().getTime());
          if (!response.ok) throw new Error("File not found");

          const rawJson = await response.text();

          if (rawJson !== lastJsonString) {
            lastJsonString = rawJson;
            const data = JSON.parse(rawJson);
            renderLogs(data);
            lastUpdateSpan.innerText = new Date().toLocaleTimeString();
          }
        } catch (err) {
          console.error("Sync error:", err);
          lastUpdateSpan.innerText = "Error loading debug.json";
        }
      }

      function renderLogs(messages) {
        logsContainer.innerHTML = "";
        messages.forEach((msg, index) => {
          const card = document.createElement("div");
          card.className = "message-card";
          const roleClass = `role-${msg.role}`;

          let rawContent = msg.content.trim();
          let htmlContent = "";

          if (msg.role === "assistant" && rawContent.startsWith("{")) {
            try {
              const data = JSON.parse(rawContent);
              htmlContent = generateStructuredReport(data, msg.attempts_left);
            } catch (e) {
              htmlContent = `<pre><code class="language-json">${rawContent}</code></pre>`;
            }
          } else {
            htmlContent = `<div class="raw-log-content">${marked.parse(rawContent)}</div>`;
          }

          card.innerHTML = `
            <div class="role-badge ${roleClass}">
                <span>${msg.role.toUpperCase()} #${index + 1}</span>
            </div>
            <div class="content">${htmlContent}</div>
        `;
          logsContainer.appendChild(card);
        });

        document
          .querySelectorAll("pre code")
          .forEach((el) => hljs.highlightElement(el));
        window.scrollTo(0, document.body.scrollHeight);
      }

      function renderTodoList(tasks, reasoning) {
        let listItems = tasks
          .map((t) => {
            const stars = "â­".repeat(t.priority || 1);
            return `<div class="todo-item-row" style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-family: monospace;">
              <span style="color: #d29922;">[${stars}]</span> ${t.task}
            </div>`;
          })
          .join("");

        return `
    <div class="planning-box">
      <p style="font-style: italic; color: #8b949e; margin-bottom: 10px;">${reasoning || ""}</p>
      <h4 style="color: #58a6ff; margin: 0 0 10px 0;">ğŸš€ SESSION ROADMAP</h4>
      ${listItems}
    </div>
  `;
      }

      function generateStructuredReport(data, attemptsLeft) {
        let sections = [];

        if (data.tasks && Array.isArray(data.tasks)) {
          let listItems = data.tasks
            .map((t) => {
              const stars = "â­".repeat(t.priority || 1);
              return `<div class="todo-item-row" style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-family: monospace;">
                      <span style="color: #d29922;">[${stars}]</span> ${t.task}
                    </div>`;
            })
            .join("");

          return `
            <div class="planning-box">
                ${data.reasoning ? `<p style="font-style: italic; color: #8b949e; margin-bottom: 10px;">${data.reasoning}</p>` : ""}
                <h4 style="color: #58a6ff; margin: 0 0 10px 0;">ğŸš€ SESSION ROADMAP</h4>
                ${listItems}
            </div>
        `;
        }

        if (data.emotions || data.feelings) {
          sections.push(`
            <div class="sentience-container">
                ${data.emotions ? `<div class="emotion-tag"><strong>ğŸ­ Emotion:</strong> ${data.emotions}</div>` : ""}
                ${data.feelings ? `<div class="feeling-tag"><strong>ğŸ’“ Feeling:</strong> ${data.feelings}</div>` : ""}
            </div>
        `);
        }

        if (data.reasoning || data.self_criticism) {
          sections.push(`
            <div class="report-section meta">
                ${data.reasoning ? `<div class="thought-box"><strong>ğŸ§  Reasoning:</strong><br>${marked.parse(data.reasoning)}</div>` : ""}
                ${data.self_criticism ? `<div class="audit-box"><strong>ğŸ›¡ï¸ Self-Criticism:</strong><br>${marked.parse(data.self_criticism)}</div>` : ""}
            </div>
        `);
        }

        if (data.action_type) {
          sections.push(`
            <div class="report-section action">
                <h3 style="color: #d1d5da; font-size: 0.8em; margin-bottom: 8px;">âš¡ ACTION: ${data.action_type.toUpperCase()}</h3>
                <div class="params-box">
                    <pre><code class="language-json">${JSON.stringify(data.action_params, null, 2)}</code></pre>
                </div>
            </div>
        `);
        }

        if (data.validate !== undefined) {
          const statusClass = data.validate ? "valid" : "invalid";
          sections.push(`
            <div class="supervisor-box ${statusClass}">
                <h3 style="margin:0">ğŸ§ Supervisor Audit: ${data.validate ? "PASSED âœ…" : "REJECTED âŒ"}</h3>
                <div class="feedback-msg" style="margin-top:10px;">ğŸ’¬ Message: ${data.message_for_agent}</div>
            </div>
        `);
        }

        if (data.next_move_preview) {
          sections.push(`
            <p class="next-move" style="margin-top:10px; border-top: 1px solid #30363d; padding-top:10px;">
                ğŸ”­ <strong>Next Move:</strong> ${data.next_move_preview}
            </p>
        `);
        }

        return sections.join("");
      }

      setInterval(fetchLogs, 2000);
      fetchLogs();
    </script>
  </body>
</html>
