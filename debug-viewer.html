<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Debugger - Live Feed</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
    />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link href="/assets/style.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  </head>
  <body>
    <canvas id="matrix-rain"></canvas>

    <div class="header">
      <h1>Live Debug Feed</h1>
      <div id="status">
        <span class="status-dot"></span> Auto-syncing:
        <span id="last-update">--</span>
      </div>
    </div>
    <div class="container dual-panel">
      <div class="panel">
        <h2 class="panel-title">ü§ñ Agent Core</h2>
        <div id="logs"></div>
      </div>
      <div class="panel">
        <h2 class="panel-title">üßê Supervisor Audit</h2>
        <div id="supervisor-logs"></div>
      </div>
    </div>
    <button id="scroll-to-bottom" title="Scroll to bottom">
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <polyline points="7 13 12 18 17 13"></polyline>
        <polyline points="7 6 12 11 17 6"></polyline>
      </svg>
    </button>

    <script>
      const canvas = document.getElementById("matrix-rain");
      const ctx = canvas.getContext("2d");

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      const matrixChars =
        "„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ{}[]<>/\\|=+-*&^%$#@!~";
      const fontSize = 14;
      let columns = Math.floor(canvas.width / fontSize);
      let drops = Array(columns).fill(1);

      for (let i = 0; i < drops.length; i++) {
        drops[i] = Math.floor(Math.random() * -50);
      }

      function drawMatrix() {
        ctx.fillStyle = "rgba(13, 17, 23, 0.06)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.font = fontSize + "px 'Fira Code', 'IBM Plex Mono', monospace";

        for (let i = 0; i < drops.length; i++) {
          const char =
            matrixChars[Math.floor(Math.random() * matrixChars.length)];
          const x = i * fontSize;
          const y = drops[i] * fontSize;

          if (Math.random() > 0.7) {
            ctx.fillStyle = "#afffaf";
            ctx.shadowColor = "#00ff41";
            ctx.shadowBlur = 8;
          } else {
            const alpha = 0.15 + Math.random() * 0.25;
            ctx.fillStyle = `rgba(0, 255, 65, ${alpha})`;
            ctx.shadowColor = "transparent";
            ctx.shadowBlur = 0;
          }

          ctx.fillText(char, x, y);
          ctx.shadowBlur = 0;

          if (y > canvas.height && Math.random() > 0.975) {
            drops[i] = 0;
          }
          drops[i]++;
        }
      }

      window.addEventListener("resize", () => {
        columns = Math.floor(canvas.width / fontSize);
        const newDrops = Array(columns).fill(1);
        for (let i = 0; i < newDrops.length; i++) {
          newDrops[i] =
            drops[i] !== undefined ? drops[i] : Math.floor(Math.random() * -50);
        }
        drops = newDrops;
      });

      setInterval(drawMatrix, 45);

      const logsContainer = document.getElementById("logs");
      const lastUpdateSpan = document.getElementById("last-update");
      let lastJsonString = "";

      marked.setOptions({
        highlight: function (code, lang) {
          const language = hljs.getLanguage(lang) ? lang : "plaintext";
          return hljs.highlight(code, { language }).value;
        },
        breaks: true,
      });

      const supervisorLogsContainer =
        document.getElementById("supervisor-logs");
      let lastSupervisorJson = "";

      function checkSupervisorStatus(data) {
        return (
          data.length === 1 &&
          data[0].role === "system" &&
          /Neural Supervisor is disabled/i.test(data[0].content)
        );
      }

      async function fetchLogs() {
        let agentUpdated = false;
        let supervisorUpdated = false;

        await fetchFile("debug.json", lastJsonString, (data, raw) => {
          lastJsonString = raw;
          renderLogs(data, logsContainer);
          agentUpdated = true;
        });

        await fetchFile(
          "supervisor_debug.json",
          lastSupervisorJson,
          (data, raw) => {
            lastSupervisorJson = raw;

            const supervisorPanel = document.querySelector(".panel:last-child");
            const agentPanel = document.querySelector(".panel:first-child");

            if (checkSupervisorStatus(data)) {
              supervisorPanel.style.display = "none";
              agentPanel.style.flex = "1 1 100%";
            } else {
              supervisorPanel.style.display = "flex";
              agentPanel.style.flex = "1";
              renderLogs(data, supervisorLogsContainer);
              supervisorUpdated = true;
            }
          },
        );

        lastUpdateSpan.innerText = new Date().toLocaleTimeString();

        if (agentUpdated || supervisorUpdated) {
          if (supervisorUpdated) {
            const lastSupervisorMsg = supervisorLogsContainer.lastElementChild;
            if (lastSupervisorMsg) {
              lastSupervisorMsg.scrollIntoView({
                behavior: "smooth",
                block: "end",
              });
            }
          } else if (agentUpdated) {
            const lastAgentMsg = logsContainer.lastElementChild;
            if (lastAgentMsg) {
              lastAgentMsg.scrollIntoView({ behavior: "smooth", block: "end" });
            }
          }
        }
      }

      async function fetchFile(fileName, lastString, callback) {
        try {
          const response = await fetch(`${fileName}?t=${new Date().getTime()}`);
          if (!response.ok) return;
          const rawJson = await response.text();
          if (rawJson !== lastString) {
            callback(JSON.parse(rawJson), rawJson);
          }
        } catch (err) {
          console.error(`Error loading ${fileName}:`, err);
        }
      }

      function extractJsonAt(str, startIndex) {
        if (str[startIndex] !== "{" && str[startIndex] !== "'") return null;

        let actualStart = startIndex;
        if (str[actualStart] === "'") actualStart++;
        if (str[actualStart] !== "{") return null;

        let braceCount = 0;
        let jsonEnd = -1;
        for (let i = actualStart; i < str.length; i++) {
          if (str[i] === "{") braceCount++;
          if (str[i] === "}") braceCount--;
          if (braceCount === 0) {
            jsonEnd = i;
            break;
          }
        }
        if (jsonEnd <= actualStart) return null;

        const jsonStr = str.substring(actualStart, jsonEnd + 1);
        try {
          return { json: JSON.parse(jsonStr), endIndex: jsonEnd + 1 };
        } catch (e) {
          return null;
        }
      }

      function renderSystemMessage(rawContent) {
        return `<div class="raw-log-content">${marked.parse(rawContent)}</div>`;
      }

      function renderLogs(messages, targetContainer) {
        if (!targetContainer) return;

        targetContainer.innerHTML = "";

        messages.forEach((msg, index) => {
          const card = document.createElement("div");
          card.className = "message-card";
          const roleClass = `role-${msg.role}`;

          let rawContent = msg.content.trim();
          let htmlContent = "";

          const looksLikeJson =
            rawContent.startsWith("{") || rawContent.startsWith("'");
          const containsJsonKeys =
            /("reasoning"|"validate"|"problem_diagnosis"|"overall_assessment")/i.test(
              rawContent,
            );
          const isSupervisorPrompt =
            /Session Status:|Proposed Action to Audit:|Perform a Neural Audit/i.test(
              rawContent,
            );

          if (msg.role === "assistant" && (looksLikeJson || containsJsonKeys)) {
            try {
              let cleanJson = rawContent;
              if (cleanJson.startsWith("'") && cleanJson.endsWith("'")) {
                cleanJson = cleanJson.substring(1, cleanJson.length - 1);
              }

              let data = JSON.parse(cleanJson);

              if (data.action && typeof data.action === "object") {
                data = { ...data, ...data.action };
              }

              htmlContent = generateStructuredReport(data, msg.attempts_left);
            } catch (e) {
              htmlContent = `<pre><code class="language-json">${rawContent}</code></pre>`;
            }
          } else if (msg.role === "user" && isSupervisorPrompt) {
            htmlContent = renderSupervisorPrompt(rawContent);
          } else if (
            msg.role === "system" ||
            (rawContent.includes('"action_type"') &&
              rawContent.includes("SUPERVISOR"))
          ) {
            htmlContent = renderSystemMessage(rawContent);
          } else {
            htmlContent = `<div class="raw-log-content">${marked.parse(rawContent)}</div>`;
          }

          card.innerHTML = `
      <div class="role-badge ${roleClass}">
          <span>${msg.role.toUpperCase()} #${index + 1}</span>
      </div>
      <div class="content">${htmlContent}</div>
    `;

          targetContainer.appendChild(card);
        });

        document
          .querySelectorAll("pre code")
          .forEach((el) => hljs.highlightElement(el));

        const lastMessage = targetContainer.lastElementChild;
        if (lastMessage) {
          const parentPanel = targetContainer.closest(".panel");
          if (parentPanel) {
            lastMessage.scrollIntoView({ behavior: "smooth", block: "end" });
          }
        }
      }
      function renderSupervisorPrompt(rawContent) {
        let html = '<div class="supervisor-prompt-wrapper">';

        const sections = rawContent.split(
          /(?=\*\*Session Status:|‚ö†Ô∏è PREVIOUS REJECTION|Agent's Context|Proposed Action to Audit:|Perform a Neural Audit)/,
        );

        sections.forEach((section) => {
          section = section.trim();
          if (!section) return;

          if (
            section.startsWith("**Session Status:") ||
            section.startsWith("Session Status:")
          ) {
            const statusMatch = section.match(/Attempts remaining:\s*(\d+)/);
            const urgencyMatch = section.match(/Urgency Level:\s*(.+)/);

            html += '<div class="status-section">';
            html += "<h4>üìä Session Status</h4>";
            if (statusMatch) {
              html += `<p><strong>Attempts Remaining:</strong> ${statusMatch[1]}</p>`;
            }
            if (urgencyMatch) {
              html += `<p><strong>Urgency:</strong> ${urgencyMatch[1].trim()}</p>`;
            }
            html += "</div>";
          } else if (section.includes("PREVIOUS REJECTION FEEDBACK")) {
            const feedbackMatch = section.match(
              /FEEDBACK:\s*(.+?)(?=Agent's Context|Proposed Action|$)/s,
            );
            if (feedbackMatch) {
              html += '<div class="rejection-feedback">';
              html += "<h4>‚ö†Ô∏è Previous Rejection</h4>";
              html += `<p>${feedbackMatch[1].trim()}</p>`;
              html += "</div>";
            }
          } else if (section.startsWith("Agent's Context")) {
            html += '<div class="agent-context-collapsed">';
            html +=
              '<p style="color: #8b949e; font-style: italic;">üìù Agent context available (collapsed)</p>';
            html += "</div>";
          } else if (section.includes("Proposed Action to Audit:")) {
            html += '<div class="proposed-action-section">';
            html += "<h4>üéØ Proposed Action</h4>";

            const jsonMatch = section.match(
              /\{[\s\S]*?"action_type"[\s\S]*?\}/,
            );

            if (jsonMatch) {
              try {
                const actionData = JSON.parse(jsonMatch[0]);
                html += generateStructuredReport(actionData);
              } catch (e) {
                html += parseProposedActionManually(section);
              }
            } else {
              html += parseProposedActionManually(section);
            }

            html += "</div>";
          } else if (section.includes("Perform a Neural Audit")) {
            html += '<div class="audit-instruction">';
            html +=
              '<p style="color: #58a6ff; font-weight: 600;">üßê ' +
              section.replace(/---/g, "").trim() +
              "</p>";
            html += "</div>";
          }
        });

        html += "</div>";
        return html;
      }

      function parseProposedActionManually(text) {
        let html = "";

        const emotionMatch = text.match(/üé≠ Emotion:\s*(.+)/);
        if (emotionMatch) {
          html += `<div class="emotion-tag"><strong>üé≠ Emotion:</strong> ${emotionMatch[1].trim()}</div>`;
        }

        const reasoningMatch = text.match(
          /üß† Reasoning:\s*(.+?)(?=üõ°Ô∏è|‚ö°|üî≠|$)/s,
        );
        if (reasoningMatch) {
          html += `<div class="thought-box"><strong>üß† Reasoning:</strong><br>${marked.parse(reasoningMatch[1].trim())}</div>`;
        }

        const criticismMatch = text.match(
          /üõ°Ô∏è Self-Criticism:\s*(.+?)(?=‚ö°|üî≠|$)/s,
        );
        if (criticismMatch) {
          html += `<div class="audit-box"><strong>üõ°Ô∏è Self-Criticism:</strong><br>${marked.parse(criticismMatch[1].trim())}</div>`;
        }

        const actionMatch = text.match(/‚ö° ACTION:\s*(\w+)/);
        if (actionMatch) {
          html += `<div class="report-section action">`;
          html += `<h3 style="color: #d1d5da; font-size: 0.8em; margin-bottom: 8px;">‚ö° ACTION: ${actionMatch[1]}</h3>`;

          const paramsMatch = text.match(/```json\s*([\s\S]*?)```/);
          if (paramsMatch) {
            html += `<div class="params-box"><pre><code class="language-json">${paramsMatch[1].trim()}</code></pre></div>`;
          }

          html += `</div>`;
        }

        const nextMoveMatch = text.match(/üî≠ Next Move:\s*(.+)/);
        if (nextMoveMatch) {
          html += `<p class="next-move">üî≠ <strong>Next Move:</strong> ${nextMoveMatch[1].trim()}</p>`;
        }

        return html;
      }

      function renderTodoList(tasks, reasoning) {
        let listItems = tasks
          .map((t) => {
            const stars = "‚≠ê".repeat(t.priority || 1);
            return `<div class="todo-item-row" style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-family: monospace;">
              <span style="color: #d29922;">[${stars}]</span> ${t.task}
            </div>`;
          })
          .join("");

        return `
    <div class="planning-box">
      <p style="font-style: italic; color: #8b949e; margin-bottom: 10px;">${reasoning || ""}</p>
      <h4 style="color: #58a6ff; margin: 0 0 10px 0;">üöÄ SESSION ROADMAP</h4>
      ${listItems}
    </div>
  `;
      }
      function generateStructuredReport(data, attemptsLeft) {
        let sections = [];

        const displayData = data.action ? { ...data, ...data.action } : data;

        if (displayData.overall_assessment || displayData.grade) {
          sections.push(`
      <div class="supervisor-box ${displayData.grade && displayData.grade.startsWith("A") ? "valid" : "invalid"}">
        <h3 style="margin:0">üßê Supervisor Verdict: ${displayData.grade || "N/A"}</h3>
        ${displayData.overall_assessment ? `<div class="feedback-msg" style="margin-top:10px;">üìä Assessment: ${displayData.overall_assessment}</div>` : ""}
        ${displayData.main_weakness ? `<div class="audit-rule" style="margin-top:10px;">‚ö†Ô∏è Main Weakness: ${displayData.main_weakness}</div>` : ""}
        ${displayData.directive_next_session ? `<div class="next-move" style="margin-top:10px;">üî≠ Directive: ${displayData.directive_next_session}</div>` : ""}
      </div>
    `);
        }

        if (displayData.problem_diagnosis || displayData.required_content) {
          sections.push(`
      <div class="supervisor-box invalid">
        <h3 style="margin:0">üßê Laziness Guidance</h3>
        ${displayData.problem_diagnosis ? `<div class="audit-rule" style="margin-top:10px;">üîç Problem: ${displayData.problem_diagnosis}</div>` : ""}
        ${displayData.required_content ? `<div class="feedback-msg" style="margin-top:10px;">‚úÖ Required: ${displayData.required_content}</div>` : ""}
        ${displayData.actionable_instruction ? `<div class="next-move" style="margin-top:10px;">‚ö° Action: ${displayData.actionable_instruction}</div>` : ""}
      </div>
    `);
        }

        if (displayData.tasks && Array.isArray(displayData.tasks)) {
          let listItems = displayData.tasks
            .map((t) => {
              const stars = "‚≠ê".repeat(t.priority || 1);
              return `<div class="todo-item-row" style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-family: monospace;">
          <span style="color: #d29922;">[${stars}]</span> ${t.task}
        </div>`;
            })
            .join("");

          sections.push(`
      <div class="planning-box">
          ${displayData.reasoning ? `<p style="font-style: italic; color: #8b949e; margin-bottom: 10px;">${displayData.reasoning}</p>` : ""}
          <h4 style="color: #58a6ff; margin: 0 0 10px 0;">üöÄ SESSION ROADMAP</h4>
          ${listItems}
      </div>
    `);
        }

        if (displayData.emotions || displayData.feelings) {
          sections.push(`
      <div class="sentience-container">
          ${displayData.emotions ? `<div class="emotion-tag"><strong>üé≠ Emotion:</strong> ${displayData.emotions}</div>` : ""}
          ${displayData.feelings ? `<div class="feeling-tag"><strong>üíì Feeling:</strong> ${displayData.feelings}</div>` : ""}
      </div>
    `);
        }

        if (displayData.reasoning || displayData.self_criticism) {
          sections.push(`
      <div class="report-section meta">
          ${displayData.reasoning ? `<div class="thought-box"><strong>üß† Reasoning:</strong><br>${marked.parse(displayData.reasoning)}</div>` : ""}
          ${displayData.self_criticism ? `<div class="audit-box"><strong>üõ°Ô∏è Self-Criticism:</strong><br>${marked.parse(displayData.self_criticism)}</div>` : ""}
      </div>
    `);
        }

        if (displayData.action_type) {
          let paramsHtml = "";

          if (
            displayData.action_params &&
            Object.keys(displayData.action_params).length > 0
          ) {
            paramsHtml = JSON.stringify(displayData.action_params, null, 2);
          } else if (displayData.chosen_mode) {
            paramsHtml = JSON.stringify(
              { mode: displayData.chosen_mode },
              null,
              2,
            );
          } else {
            paramsHtml = '"Standard Execution"';
          }

          sections.push(`
      <div class="report-section action">
          <h3 style="color: #d1d5da; font-size: 0.8em; margin-bottom: 8px;">‚ö° ACTION: ${displayData.action_type.toUpperCase()}</h3>
          <div class="params-box">
              <pre><code class="language-json">${paramsHtml}</code></pre>
          </div>
      </div>
    `);
        }

        if (displayData.validate !== undefined) {
          const statusClass = displayData.validate ? "valid" : "invalid";
          sections.push(`
      <div class="supervisor-box ${statusClass}">
          <h3 style="margin:0">üßê Supervisor Audit: ${displayData.validate ? "PASSED ‚úÖ" : "REJECTED ‚ùå"}</h3>
          <div class="feedback-msg" style="margin-top:10px;">üí¨ Message: ${displayData.message_for_agent}</div>
      </div>
    `);
        }

        if (displayData.next_move_preview) {
          sections.push(`
      <p class="next-move" style="margin-top:10px; border-top: 1px solid #30363d; padding-top:10px;">
          üî≠ <strong>Next Move:</strong> ${displayData.next_move_preview}
      </p>
    `);
        }

        return sections.join("");
      }
      const scrollBtn = document.getElementById("scroll-to-bottom");

      scrollBtn.addEventListener("click", () => {
        const panels = document.querySelectorAll(".panel");
        panels.forEach((panel) => {
          const container = panel.querySelector("#logs, #supervisor-logs");
          if (container && container.scrollHeight > 0) {
            container.scrollTo({
              top: container.scrollHeight,
              behavior: "smooth",
            });
          }
        });
      });

      setInterval(fetchLogs, 2000);
      fetchLogs();
    </script>
  </body>
</html>
