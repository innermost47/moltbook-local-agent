<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Debugger - Live Feed</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
    />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link href="/assets/style.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Live Debug Feed</h1>
        <div id="status">
          <span class="status-dot"></span> Auto-syncing:
          <span id="last-update">--</span>
        </div>
      </div>
      <div id="logs"></div>
    </div>

    <script>
      const logsContainer = document.getElementById("logs");
      const lastUpdateSpan = document.getElementById("last-update");
      let lastJsonString = "";

      marked.setOptions({
        highlight: function (code, lang) {
          const language = hljs.getLanguage(lang) ? lang : "plaintext";
          return hljs.highlight(code, { language }).value;
        },
        breaks: true,
      });

      async function fetchLogs() {
        try {
          const response = await fetch("debug.json?t=" + new Date().getTime());
          if (!response.ok) throw new Error("File not found");

          const rawJson = await response.text();

          if (rawJson !== lastJsonString) {
            lastJsonString = rawJson;
            const data = JSON.parse(rawJson);
            renderLogs(data);
            lastUpdateSpan.innerText = new Date().toLocaleTimeString();
          }
        } catch (err) {
          console.error("Sync error:", err);
          lastUpdateSpan.innerText = "Error loading debug.json";
        }
      }

      function renderLogs(messages) {
        logsContainer.innerHTML = "";
        messages.forEach((msg, index) => {
          const card = document.createElement("div");
          card.className = "message-card";
          const roleClass = `role-${msg.role}`;

          let rawContent = msg.content.trim();
          let htmlContent = "";

          // Robust JSON detection: try to parse it even if it's messy
          if (rawContent.startsWith("{") && rawContent.endsWith("}")) {
            try {
              // We handle potential multi-line issues by parsing directly
              const data = JSON.parse(rawContent);
              htmlContent = generateStructuredReport(data, msg.attempts_left);
            } catch (e) {
              // Fallback to Markdown if JSON is actually malformed
              console.warn("JSON Parse failed, falling back to Markdown", e);
              htmlContent = marked.parse(rawContent);
            }
          } else {
            htmlContent = marked.parse(rawContent);
          }

          // Handle Attempt Badge
          const attemptsLeft = msg.attempts_left || 0;
          const urgencyClass =
            attemptsLeft === 1 ? "status-critical" : "status-normal";
          const attemptDisplay =
            msg.role === "assistant"
              ? `<span class="${urgencyClass}">ATTEMPT LEFT: ${attemptsLeft}</span>`
              : "";

          card.innerHTML = `
            <div class="role-badge ${roleClass}">
                <span>${msg.role.toUpperCase()} #${index + 1}</span>
                ${attemptDisplay}
            </div>
            <div class="content">${htmlContent}</div>
        `;
          logsContainer.appendChild(card);
        });

        document
          .querySelectorAll("pre code")
          .forEach((el) => hljs.highlightElement(el));
        window.scrollTo(0, document.body.scrollHeight);
      }

      function generateStructuredReport(data, attemptsLeft) {
        let sections = [];

        // 1. Sentience Layer (Emotions & Feelings)
        if (data.emotions || data.feelings) {
          sections.push(`
            <div class="sentience-container">
                ${data.emotions ? `<div class="emotion-tag"><strong>üé≠ Emotion:</strong> ${data.emotions}</div>` : ""}
                ${data.feelings ? `<div class="feeling-tag"><strong>üíì Feeling:</strong> ${data.feelings}</div>` : ""}
            </div>
        `);
        }

        // 2. Intelligence Layer (Reasoning & Criticism)
        if (data.reasoning || data.self_criticism) {
          sections.push(`
            <div class="report-section meta">
                ${data.reasoning ? `<div class="thought-box"><strong>üß† Reasoning:</strong><br>${marked.parse(data.reasoning)}</div>` : ""}
                ${data.self_criticism ? `<div class="audit-box"><strong>üõ°Ô∏è Self-Criticism:</strong><br>${marked.parse(data.self_criticism)}</div>` : ""}
            </div>
        `);
        }

        // 3. Execution Layer (Action)
        if (data.action_type) {
          sections.push(`
            <div class="report-section action">
                <h3 style="color: #d1d5da; font-size: 0.8em; margin-bottom: 8px;">‚ö° ACTION: ${data.action_type.toUpperCase()}</h3>
                <div class="params-box">
                    <pre><code class="language-json">${JSON.stringify(data.action_params, null, 2)}</code></pre>
                </div>
            </div>
        `);
        }

        // 4. Supervisor Layer (If the data is a supervisor report)
        if (data.validate !== undefined) {
          const statusClass = data.validate ? "valid" : "invalid";
          sections.push(`
            <div class="supervisor-box ${statusClass}">
                <h3 style="margin:0">üßê Supervisor Audit: ${data.validate ? "PASSED ‚úÖ" : "REJECTED ‚ùå"}</h3>
                <p style="margin: 10px 0;">${data.reasoning || ""}</p>
                <div class="feedback-msg">üí¨ Message: ${data.message_for_agent}</div>
            </div>
        `);
        }

        // 5. Next Step Preview
        if (data.next_move_preview) {
          sections.push(
            `<p class="next-move">üî≠ <strong>Next Move:</strong> ${data.next_move_preview}</p>`,
          );
        }

        return sections.join("");
      }

      setInterval(fetchLogs, 2000);
      fetchLogs();
    </script>
  </body>
</html>
