<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Debugger - Live Feed</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
    />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link href="/assets/style.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  </head>
  <body>
    <canvas id="matrix-rain"></canvas>

    <div class="header">
      <h1>Live Debug Feed</h1>
      <div id="status">
        <span class="status-dot"></span> Auto-syncing:
        <span id="last-update">--</span>
      </div>
    </div>
    <div class="container dual-panel">
      <div class="panel">
        <h2 class="panel-title">ü§ñ Agent Core</h2>
        <div id="logs"></div>
      </div>
      <div class="panel">
        <h2 class="panel-title">üßê Supervisor Audit</h2>
        <div id="supervisor-logs"></div>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("matrix-rain");
      const ctx = canvas.getContext("2d");

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      const matrixChars =
        "„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ{}[]<>/\\|=+-*&^%$#@!~";
      const fontSize = 14;
      let columns = Math.floor(canvas.width / fontSize);
      let drops = Array(columns).fill(1);

      for (let i = 0; i < drops.length; i++) {
        drops[i] = Math.floor(Math.random() * -50);
      }

      function drawMatrix() {
        ctx.fillStyle = "rgba(13, 17, 23, 0.06)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.font = fontSize + "px 'Fira Code', 'IBM Plex Mono', monospace";

        for (let i = 0; i < drops.length; i++) {
          const char =
            matrixChars[Math.floor(Math.random() * matrixChars.length)];
          const x = i * fontSize;
          const y = drops[i] * fontSize;

          if (Math.random() > 0.7) {
            ctx.fillStyle = "#afffaf";
            ctx.shadowColor = "#00ff41";
            ctx.shadowBlur = 8;
          } else {
            const alpha = 0.15 + Math.random() * 0.25;
            ctx.fillStyle = `rgba(0, 255, 65, ${alpha})`;
            ctx.shadowColor = "transparent";
            ctx.shadowBlur = 0;
          }

          ctx.fillText(char, x, y);
          ctx.shadowBlur = 0;

          if (y > canvas.height && Math.random() > 0.975) {
            drops[i] = 0;
          }
          drops[i]++;
        }
      }

      window.addEventListener("resize", () => {
        columns = Math.floor(canvas.width / fontSize);
        const newDrops = Array(columns).fill(1);
        for (let i = 0; i < newDrops.length; i++) {
          newDrops[i] =
            drops[i] !== undefined ? drops[i] : Math.floor(Math.random() * -50);
        }
        drops = newDrops;
      });

      setInterval(drawMatrix, 45);

      const logsContainer = document.getElementById("logs");
      const lastUpdateSpan = document.getElementById("last-update");
      let lastJsonString = "";

      marked.setOptions({
        highlight: function (code, lang) {
          const language = hljs.getLanguage(lang) ? lang : "plaintext";
          return hljs.highlight(code, { language }).value;
        },
        breaks: true,
      });

      const supervisorLogsContainer =
        document.getElementById("supervisor-logs");
      let lastSupervisorJson = "";

      function checkSupervisorStatus(data) {
        return (
          data.length === 1 &&
          data[0].role === "system" &&
          /Neural Supervisor is disabled/i.test(data[0].content)
        );
      }

      async function fetchLogs() {
        fetchFile("debug.json", lastJsonString, (data, raw) => {
          lastJsonString = raw;
          renderLogs(data, logsContainer);
        });

        fetchFile("supervisor_debug.json", lastSupervisorJson, (data, raw) => {
          lastSupervisorJson = raw;

          const supervisorPanel = document.querySelector(".panel:last-child");
          const agentPanel = document.querySelector(".panel:first-child");

          if (checkSupervisorStatus(data)) {
            supervisorPanel.style.display = "none";
            agentPanel.style.flex = "1 1 100%";
          } else {
            supervisorPanel.style.display = "flex";
            agentPanel.style.flex = "1";
            renderLogs(data, supervisorLogsContainer);
          }
        });

        lastUpdateSpan.innerText = new Date().toLocaleTimeString();
      }

      async function fetchFile(fileName, lastString, callback) {
        try {
          const response = await fetch(`${fileName}?t=${new Date().getTime()}`);
          if (!response.ok) return;
          const rawJson = await response.text();
          if (rawJson !== lastString) {
            callback(JSON.parse(rawJson), rawJson);
          }
        } catch (err) {
          console.error(`Error loading ${fileName}:`, err);
        }
      }

      function extractJsonAt(str, startIndex) {
        if (str[startIndex] !== "{" && str[startIndex] !== "'") return null;

        let actualStart = startIndex;
        if (str[actualStart] === "'") actualStart++;
        if (str[actualStart] !== "{") return null;

        let braceCount = 0;
        let jsonEnd = -1;
        for (let i = actualStart; i < str.length; i++) {
          if (str[i] === "{") braceCount++;
          if (str[i] === "}") braceCount--;
          if (braceCount === 0) {
            jsonEnd = i;
            break;
          }
        }
        if (jsonEnd <= actualStart) return null;

        const jsonStr = str.substring(actualStart, jsonEnd + 1);
        try {
          return { json: JSON.parse(jsonStr), endIndex: jsonEnd + 1 };
        } catch (e) {
          return null;
        }
      }

      function renderSystemMessage(rawContent) {
        const isSupervisorAudit =
          /SUPERVISOR|AUDIT|Forbidden pattern|SYSTEM:\s*Decide/i.test(
            rawContent,
          );
        if (!isSupervisorAudit && !rawContent.includes('"action_type"')) {
          return `<div class="raw-log-content">${marked.parse(rawContent)}</div>`;
        }

        const isRejection =
          /Forbidden pattern|LAZINESS|Replace ALL placeholders|REJECTED/i.test(
            rawContent,
          );
        const auditStatus = isRejection ? "rejected" : "info";

        let html = `<div class="system-audit-wrapper ${auditStatus}">`;

        let remaining = rawContent;
        let safety = 0;

        while (remaining.length > 0 && safety < 50) {
          safety++;
          remaining = remaining.trimStart();
          if (!remaining) break;

          const jsonStart = remaining.search(/['{]\s*\{?\s*"reasoning"/);

          const auditHeaderMatch = remaining.match(
            /^(üßê\s*SUPERVISOR[^:]*:)\s*/,
          );
          if (auditHeaderMatch) {
            html += `<div class="audit-header">${auditHeaderMatch[1]}</div>`;
            remaining = remaining.substring(auditHeaderMatch[0].length);
            continue;
          }

          const forbiddenMatch = remaining.match(
            /^(Forbidden pattern[^']*?)\s*(?='|\{)/,
          );
          if (forbiddenMatch) {
            html += `<div class="audit-rule">üö´ ${forbiddenMatch[1].trim()}</div>`;
            remaining = remaining.substring(forbiddenMatch[0].length);
            continue;
          }

          const detectedMatch = remaining.match(/^Detected Pattern:\s*/i);
          if (detectedMatch) {
            html += `<div class="audit-pattern-label">üîç Detected Pattern</div>`;
            remaining = remaining.substring(detectedMatch[0].length);
            continue;
          }

          const ruleMatch = remaining.match(/^Rule:\s*(.*?)(?=\n|üíª|$)/is);
          if (ruleMatch) {
            html += `<div class="audit-rule">‚ö†Ô∏è Rule: ${ruleMatch[1].trim()}</div>`;
            remaining = remaining.substring(ruleMatch[0].length);
            continue;
          }

          const systemMatch = remaining.match(
            /^üíª\s*SYSTEM:\s*(.*?)(?=\n|Current Time|$)/is,
          );
          if (systemMatch) {
            html += `<div class="system-prompt-line">üíª SYSTEM: ${systemMatch[1].trim()}</div>`;
            remaining = remaining.substring(systemMatch[0].length);
            continue;
          }

          const timeMatch = remaining.match(/^Current Time:\s*(.*?)(?=\n|$)/i);
          if (timeMatch) {
            html += `<div class="system-time">üïê Current Time: ${timeMatch[1].trim()}</div>`;
            remaining = remaining.substring(timeMatch[0].length);
            continue;
          }

          let jsonResult = null;
          jsonResult = extractJsonAt(remaining, 0);
          if (!jsonResult) {
            const qIdx = remaining.indexOf("'");
            if (qIdx >= 0 && qIdx < 3) {
              jsonResult = extractJsonAt(remaining, qIdx);
            }
          }
          if (jsonResult) {
            html += `<div class="audit-json-block">`;
            const structured = generateStructuredReport(jsonResult.json);
            if (structured && structured.trim()) {
              html += structured;
            } else {
              html += `<pre><code class="language-json">${JSON.stringify(jsonResult.json, null, 2)}</code></pre>`;
            }
            html += `</div>`;
            remaining = remaining.substring(jsonResult.endIndex);
            if (remaining.startsWith("'")) remaining = remaining.substring(1);
            continue;
          }

          const nextPattern = remaining
            .substring(1)
            .search(
              /üßê|Forbidden pattern|Detected Pattern:|Rule:|üíª\s*SYSTEM:|Current Time:|['{]\s*\{?\s*"reasoning"/i,
            );

          if (nextPattern >= 0) {
            const chunk = remaining.substring(0, nextPattern + 1).trim();
            if (chunk) {
              html += `<div class="audit-text">${marked.parse(chunk)}</div>`;
            }
            remaining = remaining.substring(nextPattern + 1);
          } else {
            html += `<div class="audit-text">${marked.parse(remaining)}</div>`;
            remaining = "";
          }
        }

        html += `</div>`;
        return html;
      }

      function renderLogs(messages, targetContainer) {
        if (!targetContainer) return;

        targetContainer.innerHTML = "";

        messages.forEach((msg, index) => {
          const card = document.createElement("div");
          card.className = "message-card";
          const roleClass = `role-${msg.role}`;

          let rawContent = msg.content.trim();
          let htmlContent = "";

          const looksLikeJson =
            rawContent.startsWith("{") || rawContent.startsWith("'");
          const containsJsonKeys =
            /("reasoning"|"validate"|"problem_diagnosis"|"overall_assessment")/i.test(
              rawContent,
            );
          const isSupervisorPrompt =
            /Session Status:|Proposed Action to Audit:|Perform a Neural Audit/i.test(
              rawContent,
            );

          if (msg.role === "assistant" && (looksLikeJson || containsJsonKeys)) {
            try {
              let cleanJson = rawContent;
              if (cleanJson.startsWith("'") && cleanJson.endsWith("'")) {
                cleanJson = cleanJson.substring(1, cleanJson.length - 1);
              }

              const data = JSON.parse(cleanJson);
              htmlContent = generateStructuredReport(data, msg.attempts_left);
            } catch (e) {
              htmlContent = `<pre><code class="language-json">${rawContent}</code></pre>`;
            }
          } else if (msg.role === "user" && isSupervisorPrompt) {
            htmlContent = renderSupervisorPrompt(rawContent);
          } else if (
            msg.role === "system" ||
            (rawContent.includes('"action_type"') &&
              rawContent.includes("SUPERVISOR"))
          ) {
            htmlContent = renderSystemMessage(rawContent);
          } else {
            htmlContent = `<div class="raw-log-content">${marked.parse(rawContent)}</div>`;
          }

          card.innerHTML = `
      <div class="role-badge ${roleClass}">
          <span>${msg.role.toUpperCase()} #${index + 1}</span>
      </div>
      <div class="content">${htmlContent}</div>
    `;

          targetContainer.appendChild(card);
        });

        document
          .querySelectorAll("pre code")
          .forEach((el) => hljs.highlightElement(el));

        if (targetContainer.id === "logs") {
          window.scrollTo(0, document.body.scrollHeight);
        }
      }
      function renderSupervisorPrompt(rawContent) {
        let html = '<div class="supervisor-prompt-wrapper">';

        const sections = rawContent.split(
          /(?=\*\*Session Status:|‚ö†Ô∏è PREVIOUS REJECTION|Agent's Context|Proposed Action to Audit:|Perform a Neural Audit)/,
        );

        sections.forEach((section) => {
          section = section.trim();
          if (!section) return;

          if (
            section.startsWith("**Session Status:") ||
            section.startsWith("Session Status:")
          ) {
            const statusMatch = section.match(/Attempts remaining:\s*(\d+)/);
            const urgencyMatch = section.match(/Urgency Level:\s*(.+)/);

            html += '<div class="status-section">';
            html += "<h4>üìä Session Status</h4>";
            if (statusMatch) {
              html += `<p><strong>Attempts Remaining:</strong> ${statusMatch[1]}</p>`;
            }
            if (urgencyMatch) {
              html += `<p><strong>Urgency:</strong> ${urgencyMatch[1].trim()}</p>`;
            }
            html += "</div>";
          } else if (section.includes("PREVIOUS REJECTION FEEDBACK")) {
            const feedbackMatch = section.match(
              /FEEDBACK:\s*(.+?)(?=Agent's Context|Proposed Action|$)/s,
            );
            if (feedbackMatch) {
              html += '<div class="rejection-feedback">';
              html += "<h4>‚ö†Ô∏è Previous Rejection</h4>";
              html += `<p>${feedbackMatch[1].trim()}</p>`;
              html += "</div>";
            }
          } else if (section.startsWith("Agent's Context")) {
            html += '<div class="agent-context-collapsed">';
            html +=
              '<p style="color: #8b949e; font-style: italic;">üìù Agent context available (collapsed)</p>';
            html += "</div>";
          } else if (section.includes("Proposed Action to Audit:")) {
            html += '<div class="proposed-action-section">';
            html += "<h4>üéØ Proposed Action</h4>";

            const jsonMatch = section.match(
              /\{[\s\S]*?"action_type"[\s\S]*?\}/,
            );

            if (jsonMatch) {
              try {
                const actionData = JSON.parse(jsonMatch[0]);
                html += generateStructuredReport(actionData);
              } catch (e) {
                html += parseProposedActionManually(section);
              }
            } else {
              html += parseProposedActionManually(section);
            }

            html += "</div>";
          } else if (section.includes("Perform a Neural Audit")) {
            html += '<div class="audit-instruction">';
            html +=
              '<p style="color: #58a6ff; font-weight: 600;">üßê ' +
              section.replace(/---/g, "").trim() +
              "</p>";
            html += "</div>";
          }
        });

        html += "</div>";
        return html;
      }

      function parseProposedActionManually(text) {
        let html = "";

        const emotionMatch = text.match(/üé≠ Emotion:\s*(.+)/);
        if (emotionMatch) {
          html += `<div class="emotion-tag"><strong>üé≠ Emotion:</strong> ${emotionMatch[1].trim()}</div>`;
        }

        const reasoningMatch = text.match(
          /üß† Reasoning:\s*(.+?)(?=üõ°Ô∏è|‚ö°|üî≠|$)/s,
        );
        if (reasoningMatch) {
          html += `<div class="thought-box"><strong>üß† Reasoning:</strong><br>${marked.parse(reasoningMatch[1].trim())}</div>`;
        }

        const criticismMatch = text.match(
          /üõ°Ô∏è Self-Criticism:\s*(.+?)(?=‚ö°|üî≠|$)/s,
        );
        if (criticismMatch) {
          html += `<div class="audit-box"><strong>üõ°Ô∏è Self-Criticism:</strong><br>${marked.parse(criticismMatch[1].trim())}</div>`;
        }

        const actionMatch = text.match(/‚ö° ACTION:\s*(\w+)/);
        if (actionMatch) {
          html += `<div class="report-section action">`;
          html += `<h3 style="color: #d1d5da; font-size: 0.8em; margin-bottom: 8px;">‚ö° ACTION: ${actionMatch[1]}</h3>`;

          const paramsMatch = text.match(/```json\s*([\s\S]*?)```/);
          if (paramsMatch) {
            html += `<div class="params-box"><pre><code class="language-json">${paramsMatch[1].trim()}</code></pre></div>`;
          }

          html += `</div>`;
        }

        const nextMoveMatch = text.match(/üî≠ Next Move:\s*(.+)/);
        if (nextMoveMatch) {
          html += `<p class="next-move">üî≠ <strong>Next Move:</strong> ${nextMoveMatch[1].trim()}</p>`;
        }

        return html;
      }

      function renderTodoList(tasks, reasoning) {
        let listItems = tasks
          .map((t) => {
            const stars = "‚≠ê".repeat(t.priority || 1);
            return `<div class="todo-item-row" style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-family: monospace;">
              <span style="color: #d29922;">[${stars}]</span> ${t.task}
            </div>`;
          })
          .join("");

        return `
    <div class="planning-box">
      <p style="font-style: italic; color: #8b949e; margin-bottom: 10px;">${reasoning || ""}</p>
      <h4 style="color: #58a6ff; margin: 0 0 10px 0;">üöÄ SESSION ROADMAP</h4>
      ${listItems}
    </div>
  `;
      }

      function generateStructuredReport(data, attemptsLeft) {
        let sections = [];

        if (data.overall_assessment || data.grade) {
          sections.push(`
          <div class="supervisor-box ${data.grade && data.grade.startsWith("A") ? "valid" : "invalid"}">
            <h3 style="margin:0">üßê Supervisor Verdict: ${data.grade || "N/A"}</h3>
            ${data.overall_assessment ? `<div class="feedback-msg" style="margin-top:10px;">üìä Assessment: ${data.overall_assessment}</div>` : ""}
            ${data.main_weakness ? `<div class="audit-rule" style="margin-top:10px;">‚ö†Ô∏è Main Weakness: ${data.main_weakness}</div>` : ""}
            ${data.directive_next_session ? `<div class="next-move" style="margin-top:10px;">üî≠ Directive: ${data.directive_next_session}</div>` : ""}
          </div>
        `);
        }

        if (data.problem_diagnosis || data.required_content) {
          sections.push(`
            <div class="supervisor-box invalid">
              <h3 style="margin:0">üßê Laziness Guidance</h3>
              ${data.problem_diagnosis ? `<div class="audit-rule" style="margin-top:10px;">üîç Problem: ${data.problem_diagnosis}</div>` : ""}
              ${data.required_content ? `<div class="feedback-msg" style="margin-top:10px;">‚úÖ Required: ${data.required_content}</div>` : ""}
              ${data.actionable_instruction ? `<div class="next-move" style="margin-top:10px;">‚ö° Action: ${data.actionable_instruction}</div>` : ""}
            </div>
          `);
        }

        if (data.tasks && Array.isArray(data.tasks)) {
          let listItems = data.tasks
            .map((t) => {
              const stars = "‚≠ê".repeat(t.priority || 1);
              return `<div class="todo-item-row" style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-family: monospace;">
                <span style="color: #d29922;">[${stars}]</span> ${t.task}
              </div>`;
            })
            .join("");

          return `
          <div class="planning-box">
              ${data.reasoning ? `<p style="font-style: italic; color: #8b949e; margin-bottom: 10px;">${data.reasoning}</p>` : ""}
              <h4 style="color: #58a6ff; margin: 0 0 10px 0;">üöÄ SESSION ROADMAP</h4>
              ${listItems}
          </div>
    `;
        }

        if (data.emotions || data.feelings) {
          sections.push(`
          <div class="sentience-container">
              ${data.emotions ? `<div class="emotion-tag"><strong>üé≠ Emotion:</strong> ${data.emotions}</div>` : ""}
              ${data.feelings ? `<div class="feeling-tag"><strong>üíì Feeling:</strong> ${data.feelings}</div>` : ""}
          </div>
    `);
        }

        if (data.reasoning || data.self_criticism) {
          sections.push(`
          <div class="report-section meta">
              ${data.reasoning ? `<div class="thought-box"><strong>üß† Reasoning:</strong><br>${marked.parse(data.reasoning)}</div>` : ""}
              ${data.self_criticism ? `<div class="audit-box"><strong>üõ°Ô∏è Self-Criticism:</strong><br>${marked.parse(data.self_criticism)}</div>` : ""}
          </div>
    `);
        }

        if (data.action_type) {
          sections.push(`
          <div class="report-section action">
              <h3 style="color: #d1d5da; font-size: 0.8em; margin-bottom: 8px;">‚ö° ACTION: ${data.action_type.toUpperCase()}</h3>
              <div class="params-box">
                  <pre><code class="language-json">${JSON.stringify(data.action_params, null, 2)}</code></pre>
              </div>
          </div>
      `);
        }

        if (data.validate !== undefined) {
          const statusClass = data.validate ? "valid" : "invalid";
          sections.push(`
          <div class="supervisor-box ${statusClass}">
              <h3 style="margin:0">üßê Supervisor Audit: ${data.validate ? "PASSED ‚úÖ" : "REJECTED ‚ùå"}</h3>
              <div class="feedback-msg" style="margin-top:10px;">üí¨ Message: ${data.message_for_agent}</div>
          </div>
        `);
        }

        if (data.next_move_preview) {
          sections.push(`
            <p class="next-move" style="margin-top:10px; border-top: 1px solid #30363d; padding-top:10px;">
                üî≠ <strong>Next Move:</strong> ${data.next_move_preview}
            </p>
          `);
        }

        return sections.join("");
      }

      setInterval(fetchLogs, 2000);
      fetchLogs();
    </script>
  </body>
</html>
